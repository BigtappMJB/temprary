import React, { useState, useEffect } from 'react';
import {
  Box,
  Button,
  Paper,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Typography,
  TextField,
  InputAdornment,
  TablePagination,
  Dialog,
  DialogActions,
  DialogContent,
  DialogTitle,
  DialogContentText,
  Grid,
  IconButton,
  Tooltip,
  Snackbar,
  Alert
} from '@mui/material';
import {
  Edit as EditIcon,
  Delete as DeleteIcon,
  Search as SearchIcon,
  Refresh as RefreshIcon,
  ArrowUpward as ArrowUpwardIcon,
  ArrowDownward as ArrowDownwardIcon,
  Close as CloseIcon
} from '@mui/icons-material';

/**
 * ${ component_name } - Component for ${ table_name }
 */
const ${ component_name } = () => {
  // State for data
  const [data, setData] = useState([]);
  const [filteredData, setFilteredData] = useState([]);
  const [loading, setLoading] = useState(false);
  
  // State for notifications
  const [notification, setNotification] = useState({
    open: false,
    message: '',
    severity: 'info' // 'success', 'info', 'warning', 'error'
  });
  
  $% if options.pagination %$
  // State for pagination
  const [page, setPage] = useState(0);
  const [rowsPerPage, setRowsPerPage] = useState(5);
  $% endif %$
  
  $% if options.search %$
  // State for search
  const [searchQuery, setSearchQuery] = useState('');
  $% endif %$
  
  $% if options.sorting %$
  // State for sorting
  const [sortBy, setSortBy] = useState('${ primary_key }');
  const [sortDirection, setSortDirection] = useState('asc');
  $% endif %$
  
  $% if options.crud %$
  // State for form
  const [open, setOpen] = useState(false);
  const [formMode, setFormMode] = useState('create'); // 'create' or 'edit'
  const [currentItem, setCurrentItem] = useState(null);
  const [formData, setFormData] = useState({
    $% for field in all_fields %$
    ${ field.name }: null$% if not loop.last %$,$% endif %$
    $% endfor %$
  });
  
  // State for delete confirmation
  const [deleteDialogOpen, setDeleteDialogOpen] = useState(false);
  const [itemToDelete, setItemToDelete] = useState(null);
  $% endif %$
  
  // Fetch data on component mount
  useEffect(() => {
    // Mock data for demonstration
    const mockData = [];
    for (let i = 1; i <= 10; i++) {
      mockData.push({
        $% for field in all_fields %$
        ${ field.name }: generateMockValue('${ field.type }', '${ field.name }', i)$% if not loop.last %$,$% endif %$
        $% endfor %$
      });
    }
    setData(mockData);
    setFilteredData(mockData);
  }, []);
  
  $% if options.search or options.sorting %$
  // Apply filtering and sorting
  useEffect(() => {
    let result = [...data];
    
    $% if options.search %$
    // Apply search filter
    if (searchQuery && searchQuery.trim() !== '') {
      const lowercasedQuery = searchQuery.toLowerCase();
      result = result.filter(item => {
        // Search through all fields
        return Object.keys(item).some(key => {
          const value = item[key];
          if (value === null || value === undefined) return false;
          return String(value).toLowerCase().includes(lowercasedQuery);
        });
      });
      $% if options.pagination %$
      // Reset to first page when search changes
      setPage(0);
      $% endif %$
    }
    $% endif %$
    
    $% if options.sorting %$
    // Apply sorting
    result.sort((a, b) => {
      const aValue = a[sortBy];
      const bValue = b[sortBy];
      
      if (aValue === bValue) return 0;
      
      if (sortDirection === 'asc') {
        return aValue < bValue ? -1 : 1;
      } else {
        return aValue > bValue ? -1 : 1;
      }
    });
    $% endif %$
    
    setFilteredData(result);
  }, [data$% if options.search %$, searchQuery$% endif %$$% if options.sorting %$, sortBy, sortDirection$% endif %$]);
  $% endif %$
  
  // Generate mock value based on field type
  const generateMockValue = (type, name, index) => {
    if (name === '${ primary_key }') {
      return index;
    } else if (name.includes('name')) {
      return `Sample ${name} ${index}`;
    } else if (type.includes('INT')) {
      return index * 10;
    } else if (type.includes('DATE')) {
      return new Date().toISOString();
    } else {
      return `Sample ${name} ${index}`;
    }
  };

  $% if options.refresh %$
  // Handle refresh
  const handleRefresh = () => {
    // In a real app, this would fetch fresh data from the API
    // For this demo, we'll just regenerate mock data
    const mockData = [];
    for (let i = 1; i <= 10; i++) {
      mockData.push({
        $% for field in all_fields %$
        ${ field.name }: generateMockValue('${ field.type }', '${ field.name }', i)$% if not loop.last %$,$% endif %$
        $% endfor %$
      });
    }
    setData(mockData);
    setFilteredData(mockData);
    
    // Show success notification
    setNotification({
      open: true,
      message: 'Data refreshed successfully',
      severity: 'success'
    });
  };
  $% endif %$
  
  $% if options.crud %$
  // Handle form input changes
  const handleInputChange = (e) => {
    const { name, value } = e.target;
    setFormData(prev => ({
      ...prev,
      [name]: value
    }));
  };
  
  // Handle form submission
  const handleSubmit = () => {
    if (formMode === 'create') {
      // Add new item to data
      const newItem = {
        ...formData,
        // Ensure primary key is set for new items
        ${ primary_key }: data.length > 0 ? Math.max(...data.map(item => item.${ primary_key })) + 1 : 1
      };
      setData(prev => [...prev, newItem]);
      
      // Show success notification
      setNotification({
        open: true,
        message: 'New record created successfully',
        severity: 'success'
      });
    } else {
      // Update existing item
      setData(prev => prev.map(item => 
        item.${ primary_key } === currentItem.${ primary_key } ? { ...formData } : item
      ));
      
      // Show success notification
      setNotification({
        open: true,
        message: 'Record updated successfully',
        severity: 'success'
      });
    }
    handleClose();
  };
  
  // Handle create dialog open
  const handleCreateOpen = () => {
    setFormMode('create');
    setFormData({
      $% for field in all_fields %$
      ${ field.name }: null$% if not loop.last %$,$% endif %$
      $% endfor %$
    });
    setOpen(true);
  };
  
  // Handle edit dialog open
  const handleEditOpen = (item) => {
    setFormMode('edit');
    setCurrentItem(item);
    setFormData({ ...item });
    setOpen(true);
  };
  
  // Handle dialog close
  const handleClose = () => {
    setOpen(false);
    setCurrentItem(null);
  };
  
  // Handle delete dialog open
  const handleDeleteOpen = (item) => {
    setItemToDelete(item);
    setDeleteDialogOpen(true);
  };
  
  // Handle delete dialog close
  const handleDeleteClose = () => {
    setDeleteDialogOpen(false);
    setItemToDelete(null);
  };
  
  // Handle delete confirmation
  const handleDeleteConfirm = () => {
    if (itemToDelete) {
      setData(prev => prev.filter(item => item.${ primary_key } !== itemToDelete.${ primary_key }));
      
      // Show success notification
      setNotification({
        open: true,
        message: 'Record deleted successfully',
        severity: 'success'
      });
    }
    handleDeleteClose();
  };
  $% endif %$
  
  $% if options.pagination %$
  // Handle pagination
  const handleChangePage = (event, newPage) => {
    setPage(newPage);
  };
  
  const handleChangeRowsPerPage = (event) => {
    setRowsPerPage(parseInt(event.target.value, 10));
    setPage(0);
  };
  $% endif %$
  
  $% if options.search %$
  // Handle search
  const handleSearchChange = (event) => {
    setSearchQuery(event.target.value);
  };
  $% endif %$
  
  $% if options.sorting %$
  // Handle sorting
  const handleSort = (column) => {
    if (sortBy === column) {
      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
    } else {
      setSortBy(column);
      setSortDirection('asc');
    }
  };
  $% endif %$
  
  // Handle notification close
  const handleNotificationClose = (event, reason) => {
    if (reason === 'clickaway') {
      return;
    }
    setNotification({...notification, open: false});
  };
  
  $% if options.pagination %$
  // Get paginated data
  const displayData = filteredData.slice(page * rowsPerPage, page * rowsPerPage + rowsPerPage);
  $% else %$
  // Use all filtered data
  const displayData = filteredData;
  $% endif %$
  
  return (
    <Box sx={{ width: '100%' }}>
      <Paper elevation={3} sx={{ width: '100%', mb: 2, p: { xs: 1, sm: 2 }, overflow: 'hidden' }}>
        {/* Header section with responsive layout */}
        <Box sx={{ 
          display: 'flex', 
          flexDirection: { xs: 'column', sm: 'row' }, 
          justifyContent: 'space-between', 
          alignItems: { xs: 'stretch', sm: 'center' },
          gap: 2,
          mb: 2 
        }}>
          <Typography 
            variant="h6" 
            component="div" 
            sx={{ 
              fontSize: { xs: '1.1rem', sm: '1.25rem' },
              mb: { xs: 1, sm: 0 }
            }}
          >
            ${ page_title }
          </Typography>
          
          <Box sx={{ 
            display: 'flex', 
            flexDirection: { xs: 'column', sm: 'row' }, 
            gap: 1,
            width: { xs: '100%', sm: 'auto' }
          }}>
            $% if options.search %$
            <TextField
              size="small"
              placeholder="Search..."
              value={searchQuery}
              onChange={handleSearchChange}
              fullWidth
              sx={{ 
                minWidth: { sm: '200px' },
                maxWidth: { sm: '300px' }
              }}
              InputProps={{
                startAdornment: (
                  <InputAdornment position="start">
                    <SearchIcon fontSize="small" />
                  </InputAdornment>
                ),
              }}
            />
            $% endif %$
            
            <Box sx={{ 
              display: 'flex', 
              gap: 1,
              justifyContent: { xs: 'flex-end', sm: 'flex-start' }
            }}>
              $% if options.refresh %$
              <Tooltip title="Refresh data">
                <IconButton color="primary" onClick={handleRefresh} size="small">
                  <RefreshIcon />
                </IconButton>
              </Tooltip>
              $% endif %$
              
              $% if options.crud %$
              <Button 
                variant="contained" 
                onClick={handleCreateOpen}
                size="small"
                startIcon={<EditIcon />}
                sx={{ 
                  whiteSpace: 'nowrap',
                  display: { xs: 'flex' }
                }}
              >
                Add New
              </Button>
              $% endif %$
            </Box>
          </Box>
        </Box>
        
        {/* Responsive table container */}
        <Box sx={{ overflow: 'auto', maxWidth: '100%' }}>
          <Table size="small" sx={{ minWidth: 650 }}>
            <TableHead>
              <TableRow>
                $% for field in fields %$
                <TableCell
                  $% if options.sorting and field.get('sortable', True) %$
                  onClick={() => handleSort('${ field.name }')}
                  sx={{ 
                    cursor: 'pointer',
                    whiteSpace: 'nowrap',
                    padding: { xs: '8px 6px', sm: '16px 8px' }
                  }}
                  $% else %$
                  sx={{ 
                    whiteSpace: 'nowrap',
                    padding: { xs: '8px 6px', sm: '16px 8px' }
                  }}
                  $% endif %$
                >
                  <Box sx={{ display: 'flex', alignItems: 'center' }}>
                    ${ field.name | replace('_', ' ') | title }
                    $% if options.sorting and field.get('sortable', True) %$
                    {sortBy === '${ field.name }' && (
                      sortDirection === 'asc' ? 
                        <ArrowUpwardIcon fontSize="small" sx={{ ml: 0.5 }} /> : 
                        <ArrowDownwardIcon fontSize="small" sx={{ ml: 0.5 }} />
                    )}
                    $% endif %$
                  </Box>
                </TableCell>
                $% endfor %$
                
                $% if options.crud %$
                <TableCell 
                  align="right"
                  sx={{ 
                    whiteSpace: 'nowrap',
                    padding: { xs: '8px 6px', sm: '16px 8px' }
                  }}
                >
                  Actions
                </TableCell>
                $% endif %$
              </TableRow>
            </TableHead>
            <TableBody>
              {displayData.length > 0 ? (
                displayData.map((row) => (
                  <TableRow key={row.${ primary_key }} hover>
                    $% for field in fields %$
                    <TableCell 
                      sx={{ 
                        padding: { xs: '8px 6px', sm: '16px 8px' },
                        maxWidth: { xs: '120px', sm: '200px', md: '300px' },
                        overflow: 'hidden',
                        textOverflow: 'ellipsis',
                        whiteSpace: { xs: 'nowrap', md: 'normal' }
                      }}
                    >
                      {String(row.${ field.name })}
                    </TableCell>
                    $% endfor %$
                    
                    $% if options.crud %$
                    <TableCell 
                      align="right"
                      sx={{ 
                        padding: { xs: '4px', sm: '8px' },
                        whiteSpace: 'nowrap'
                      }}
                    >
                      <Tooltip title="Edit">
                        <IconButton 
                          size="small" 
                          color="primary" 
                          onClick={() => handleEditOpen(row)}
                          sx={{ padding: { xs: '4px', sm: '8px' } }}
                        >
                          <EditIcon fontSize="small" />
                        </IconButton>
                      </Tooltip>
                      <Tooltip title="Delete">
                        <IconButton 
                          size="small" 
                          color="error" 
                          onClick={() => handleDeleteOpen(row)}
                          sx={{ padding: { xs: '4px', sm: '8px' } }}
                        >
                          <DeleteIcon fontSize="small" />
                        </IconButton>
                      </Tooltip>
                    </TableCell>
                    $% endif %$
                  </TableRow>
                ))
              ) : (
                <TableRow>
                  <TableCell colSpan={${fields | length}$% if options.crud %$ + 1$% endif %$} align="center">
                    {loading ? 'Loading...' : 'No data found'}
                  </TableCell>
                </TableRow>
              )}
            </TableBody>
          </Table>
        </Box>
        
        $% if options.pagination %$
        <TablePagination
          rowsPerPageOptions={[5, 10, 25]}
          component="div"
          count={filteredData.length}
          rowsPerPage={rowsPerPage}
          page={page}
          onPageChange={handleChangePage}
          onRowsPerPageChange={handleChangeRowsPerPage}
          sx={{
            '.MuiTablePagination-selectLabel, .MuiTablePagination-displayedRows': {
              margin: { xs: 0 },
              fontSize: { xs: '0.75rem', sm: '0.875rem' }
            },
            '.MuiTablePagination-select': {
              paddingLeft: { xs: '4px', sm: '8px' },
              paddingRight: { xs: '4px', sm: '8px' }
            }
          }}
        />
        $% endif %$
      </Paper>
      
      $% if options.crud %$
      {/* Create/Edit Dialog */}
      <Dialog 
        open={open} 
        onClose={handleClose} 
        maxWidth="md" 
        fullWidth
        PaperProps={{
          sx: {
            width: { xs: '95%', sm: '80%', md: '70%' },
            maxHeight: { xs: '95vh', sm: '80vh' },
            overflowY: 'auto'
          }
        }}
      >
        <DialogTitle sx={{ 
          fontSize: { xs: '1.1rem', sm: '1.25rem' },
          pb: 1
        }}>
          {formMode === 'create' ? 'Add New' : 'Edit'} ${ table_name | replace('_', ' ') | title }
        </DialogTitle>
        <DialogContent dividers sx={{ p: { xs: 1, sm: 2 } }}>
          <Grid container spacing={{ xs: 1, sm: 2 }}>
            $% for field in all_fields %$
            $% if not field.primaryKey %$
            <Grid item xs={12} sm={6}>
              <TextField
                margin="dense"
                fullWidth
                id="${ field.name }"
                label="${ field.name | replace('_', ' ') | title }"
                name="${ field.name }"
                value={formData.${ field.name } || ''}
                onChange={handleInputChange}
                size="small"
                sx={{
                  '& .MuiInputLabel-root': {
                    fontSize: { xs: '0.875rem', sm: '1rem' }
                  },
                  '& .MuiInputBase-input': {
                    fontSize: { xs: '0.875rem', sm: '1rem' }
                  }
                }}
              />
            </Grid>
            $% endif %$
            $% endfor %$
          </Grid>
        </DialogContent>
        <DialogActions sx={{ p: { xs: 1.5, sm: 2 }, justifyContent: 'space-between' }}>
          <Button 
            onClick={handleClose}
            size="small"
            sx={{ fontSize: { xs: '0.8125rem', sm: '0.875rem' } }}
          >
            Cancel
          </Button>
          <Button 
            onClick={handleSubmit} 
            variant="contained" 
            color="primary"
            size="small"
            sx={{ fontSize: { xs: '0.8125rem', sm: '0.875rem' } }}
          >
            {formMode === 'create' ? 'Save' : 'Update'}
          </Button>
        </DialogActions>
      </Dialog>
      
      {/* Delete Confirmation Dialog */}
      <Dialog 
        open={deleteDialogOpen} 
        onClose={handleDeleteClose}
        PaperProps={{
          sx: {
            width: { xs: '95%', sm: '450px' },
            maxWidth: '95%'
          }
        }}
      >
        <DialogTitle sx={{ 
          fontSize: { xs: '1.1rem', sm: '1.25rem' },
          pb: 1
        }}>
          Confirm Delete
        </DialogTitle>
        <DialogContent dividers>
          <DialogContentText sx={{ fontSize: { xs: '0.875rem', sm: '1rem' } }}>
            Are you sure you want to delete this item? This action cannot be undone.
          </DialogContentText>
        </DialogContent>
        <DialogActions sx={{ p: { xs: 1.5, sm: 2 }, justifyContent: 'space-between' }}>
          <Button 
            onClick={handleDeleteClose}
            size="small"
            sx={{ fontSize: { xs: '0.8125rem', sm: '0.875rem' } }}
          >
            Cancel
          </Button>
          <Button 
            onClick={handleDeleteConfirm} 
            color="error" 
            variant="contained"
            size="small"
            sx={{ fontSize: { xs: '0.8125rem', sm: '0.875rem' } }}
          >
            Delete
          </Button>
        </DialogActions>
      </Dialog>
      $% endif %$
      
      {/* Notification Snackbar */}
      <Snackbar
        open={notification.open}
        autoHideDuration={5000}
        onClose={handleNotificationClose}
        anchorOrigin={{ vertical: 'bottom', horizontal: 'right' }}
        sx={{
          bottom: { xs: '24px', sm: '24px' },
          right: { xs: '16px', sm: '24px' }
        }}
      >
        <Alert
          onClose={handleNotificationClose}
          severity={notification.severity}
          variant="filled"
          sx={{ 
            width: '100%',
            alignItems: 'center',
            fontSize: { xs: '0.8125rem', sm: '0.875rem' }
          }}
          action={
            <IconButton
              size="small"
              aria-label="close"
              color="inherit"
              onClick={handleNotificationClose}
            >
              <CloseIcon fontSize="small" />
            </IconButton>
          }
        >
          {notification.message}
        </Alert>
      </Snackbar>
    </Box>
  );
};

export default ${ component_name };